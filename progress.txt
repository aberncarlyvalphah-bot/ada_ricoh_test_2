# Progress Log

## 2026-02-19 - Fix: 修复文件上传包含中文字符时的错误（Invalid key）

### What was done:
- **问题**: 上传包含中文字符和特殊字符的文件时，出现错误 "Invalid key: user_001/1771516629424-第三方LLM平台接口20250120.xlsx"
- **根本原因**: `fileService.ts` 中的文件 ID 生成使用了 `${Date.now()}-${file.name}`，包含了原始文件名中的中文字符和特殊字符，导致 Supabase Storage/Database 拒绝

- **修复方案**:
  - 添加 `generateFileId()` 函数：仅使用时间戳 + 随机数生成安全的数据库 ID
  - 添加 `sanitizeFileName()` 函数：移除文件系统不支持的字符，但保留中文字符
  - 分离 Storage 路径和数据库键：
    - 数据库键：使用 `generateFileId()` 生成（纯数字和连字符）
    - Storage 路径：使用 `sanitizeFileName()` 处理（保留中文，移除特殊字符）
    - 显示名称：在数据库中保存原始文件名
  - 修复了 `validateFileData()` 函数的语法错误
  - 添加 `DatabaseFile` 类型，修复 TypeScript 的 `any` 类型警告

- **文件修改** (`lib/supabase/fileService.ts`):
  ```typescript
  // 生成安全的唯一文件 ID
  function generateFileId(): string {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 100000);
    return `${timestamp}-${random}`;
  }

  // 生成安全的文件名（用于 Storage）
  function sanitizeFileName(fileName: string): string {
    return fileName
      .replace(/[\\/:*?"<>|]/g, '_')  // 移除文件系统不支持的字符
      .replace(/\s+/g, '_')           // 替换空白字符
      .replace(/_+/g, '_')             // 移除连续下划线
      .replace(/^[_\.]+|[_\.]+$/g, '') // 移除首尾下划线和点
      .substring(0, 100);              // 限制长度
  }

  // 数据库文件记录类型
  type DatabaseFile = {
    id: string;
    user_id: string;
    file_name: string;
    file_size: number;
    file_type: string;
    file_path: string;
    file_url: string;
    row_count: number;
    column_count: number;
    uploaded_at: string;
  };
  ```

### Testing:
- ✅ npm run build 成功
- ✅ TypeScript 编译通过
- ✅ 修复了所有 fileService.ts 相关的 lint 错误
- ✅ 修复了 validateFileData 函数的语法错误

### Notes:
- 现在支持上传包含中文、特殊字符的文件名
- Storage 路径会自动清理不兼容的字符（如 `/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`）
- 用户在界面上看到的仍然是原始文件名，但后台使用的是安全的 ID 和路径
- 文件路径生成逻辑：`{userId}/{sanitizedFileNameWithoutExtension}`

---

## 2026-02-19 - 修复文件上传后的文件引用和展示问题（第三版）

### What was done:
- **问题3 - 文件去重**（已在之前完成）：
  - 在 lib/supabase/fileService.ts 中添加 `deduplicateFiles()` 函数
  - 根据 file_name + file_size 去重，保留最新的文件
  - 在 getUserFiles() 中调用去重逻辑

- **问题1 - 修复布局和自动引用**：
  - 修改 components/home/ChatInput.tsx：
    - 添加独立的文件上传功能（uploadFiles、isUploading 状态）
    - 上传成功后自动调用 `onUploadComplete` 回调
    - 上传中显示 "上传中..." 状态
    - 上传失败时显示错误提示
  - 文件列表显示紫色背景样式（bg-primary/10 text-primary）

  - 修改 components/layout/AppLayout.tsx：
    - 添加 `onUploadComplete` prop 传递给 Sidebar

  - 修改 components/layout/Sidebar.tsx：
    - Projects 区域改为 `flex-none`（固定高度，让 File Library 自动填充剩余空间）
    - File Library 区域改为 `flex-1 flex-col min-h-0`（动态填充）
    - 移除上传对话框和相关代码
    - 移除 `handleUpload` 函数
    - 修改为接收 `onUploadComplete` 回调
    - 在文件项引用按钮点击时调用回调

  - 修改 app/page.tsx：
    - 实现完整的文件上传状态管理
    - 添加 `handleUploadComplete` 函数
    - 添加文件去重逻辑（避免重复添加到附件列表）
    - 传递 `onUploadComplete` 给 AppLayout 和 ChatInput

### Testing:
- ✅ npm run build 成功
- ✅ TypeScript 编译通过
- ✅ 文件库布局已优化（Projects 固定高度，File Library 动态填充）
- ✅ 上传功能完全集成到 ChatInput
- ✅ 上传后自动引用文件到输入框
- ✅ 文件库引用按钮点击也能添加到输入框

### Notes:
- ChatInput 现在是独立的文件上传入口，不再依赖 Sidebar
- 上传完成后通过 `onUploadComplete` 回调机制通知其他组件
- 文件上传、引用、删除三者的数据流现在完全统一

---

## 2026-02-19 - Fix: Add independent scrollbars for left and right panels
