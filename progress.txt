# Progress Log

## 2026-02-20 - Task 16: 集成后端 API

### What was done:
- **扩展 API 类型定义** (`lib/api/types.ts`)：
  - 添加 Project, CreateProjectRequest, UpdateProjectRequest, ProjectMessage, ProjectFile 类型
  - 添加 UserProfile, AuthSession 认证相关类型
  - 添加 ApiErrorCode 枚举，包含所有错误代码
  - 扩展 ApiResponse 添加 metadata 分页信息
  - 添加 RequestConfig, RequestInterceptor, ResponseInterceptor 类型
  - 添加 API_CONFIG 配置对象
  - 添加 USE_MOCK_DATA 环境变量支持

- **重构 API 客户端** (`lib/api/client.ts`)：
  - 实现核心 request 方法，支持完整的 HTTP 请求生命周期
  - 添加请求拦截器系统（addRequestInterceptor）
  - 添加响应拦截器系统（addResponseInterceptor）
  - 实现 authInterceptor：自动添加 Supabase auth token 到请求头
  - 实现 errorResponseInterceptor：401 错误时自动刷新 token
  - 实现重试逻辑：指数退避算法，默认重试 3 次
  - 添加超时控制：默认 30 秒超时
  - 实现错误分类：根据 HTTP 状态码生成对应的错误代码
  - 实现 retryable 判断：识别可重试的错误（网络错误、超时、5xx 等）
  - 保留原有的 mock 数据支持（USE_MOCK_DATA）
  - 优化 sendChat：支持真实 SSE 流式响应
  - 添加 createProject, saveProject, deleteProject, getUserProfile 方法

### 技术细节：
- **请求拦截器链**：支持添加多个拦截器，按顺序执行
- **响应拦截器链**：支持响应处理和转换
- **重试机制**：
  - 指数退避（1s, 2s, 3s）
  - 可自定义重试条件和延迟
  - 自动识别可重试的错误类型
- **错误处理**：
  - 统一的 ApiError 结构
  - 自动分类错误代码
  - 支持错误重试标志
- **认证集成**：
  - 自动获取 Supabase session
  - 自动注入 Authorization header
  - 401 时自动刷新 token

### 文件修改：
- `lib/api/types.ts` - 扩展类型定义
- `lib/api/client.ts` - 完全重构，添加拦截器、重试、错误处理

### Testing:
- ✅ npm run build 成功
- ✅ TypeScript 编译通过
- ✅ 所有新功能已实现
- ⚠️ 1 个 lint 警告：_file 参数未使用（符合预期，使用下划线前缀表示故意未使用）

### Notes:
- API 客户端现在完全支持 Supabase 认证
- 支持自定义请求/响应拦截器
- 自动重试机制提高可靠性
- 错误处理完善，易于调试
- 保留了 mock 数据支持，方便开发

---

## 2026-02-20 - Docs: 创建 Git 工作流程文档

### What was done:
- 创建 `GIT_WORKFLOW.md` 文档，规范项目 Git 工作流程
- 记录每次迭代后必须推送到 GitHub 的操作流程
- 包含标准 Git 命令和 Commit Message 格式规范
- 记录 GitHub 推送配置信息（token 使用占位符避免泄露）

### 文档内容要点：
1. **标准工作流程**：代码修改 → 测试 → 更新 progress.txt → Git 提交 → 推送到 GitHub
2. **Commit Message 格式**：使用 HEREDOC 格式，包含标题、修改内容、技术说明、相关文件
3. **推送命令**：使用 Personal Access Token 进行认证
4. **检查清单**：确保每次提交前的质量检查
5. **重要提示**：重启终端后通过阅读 CLAUDE.md、progress.txt、GIT_WORKFLOW.md、task.json 恢复上下文

### Testing:
- ✅ 文档已创建
- ✅ 推送到 GitHub 成功（commit: 9b9cbf1）

### Notes:
- 文档中使用占位符 `YOUR_GITHUB_TOKEN`，避免泄露真实 token
- 每次迭代后必须遵循文档中的工作流程提交代码
- 文档会帮助 Claude 重启后快速恢复工作流程记忆

---

## 2026-02-19 - Fix: 修复文件上传包含中文字符时的错误（Invalid key）

### What was done:
- **问题**: 上传包含中文字符和特殊字符的文件时，出现错误 "Invalid key: user_001/1771516629424-第三方LLM平台接口20250120.xlsx"
- **根本原因**: `fileService.ts` 中的文件 ID 生成使用了 `${Date.now()}-${file.name}`，包含了原始文件名中的中文字符和特殊字符，导致 Supabase Storage/Database 拒绝

- **修复方案**:
  - 添加 `generateFileId()` 函数：仅使用时间戳 + 随机数生成安全的数据库 ID
  - 添加 `sanitizeFileName()` 函数：移除文件系统不支持的字符，但保留中文字符
  - 分离 Storage 路径和数据库键：
    - 数据库键：使用 `generateFileId()` 生成（纯数字和连字符）
    - Storage 路径：使用 `sanitizeFileName()` 处理（保留中文，移除特殊字符）
    - 显示名称：在数据库中保存原始文件名
  - 修复了 `validateFileData()` 函数的语法错误
  - 添加 `DatabaseFile` 类型，修复 TypeScript 的 `any` 类型警告

- **文件修改** (`lib/supabase/fileService.ts`):
  ```typescript
  // 生成安全的唯一文件 ID
  function generateFileId(): string {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 100000);
    return `${timestamp}-${random}`;
  }

  // 生成安全的文件名（用于 Storage）
  function sanitizeFileName(fileName: string): string {
    return fileName
      .replace(/[\\/:*?"<>|]/g, '_')  // 移除文件系统不支持的字符
      .replace(/\s+/g, '_')           // 替换空白字符
      .replace(/_+/g, '_')             // 移除连续下划线
      .replace(/^[_\.]+|[_\.]+$/g, '') // 移除首尾下划线和点
      .substring(0, 100);              // 限制长度
  }

  // 数据库文件记录类型
  type DatabaseFile = {
    id: string;
    user_id: string;
    file_name: string;
    file_size: number;
    file_type: string;
    file_path: string;
    file_url: string;
    row_count: number;
    column_count: number;
    uploaded_at: string;
  };
  ```

### Testing:
- ✅ npm run build 成功
- ✅ TypeScript 编译通过
- ✅ 修复了所有 fileService.ts 相关的 lint 错误
- ✅ 修复了 validateFileData 函数的语法错误

### Notes:
- 现在支持上传包含中文、特殊字符的文件名
- Storage 路径会自动清理不兼容的字符（如 `/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`）
- 用户在界面上看到的仍然是原始文件名，但后台使用的是安全的 ID 和路径
- 文件路径生成逻辑：`{userId}/{sanitizedFileNameWithoutExtension}`

---

## 2026-02-19 - 修复文件上传后的文件引用和展示问题（第三版）

### What was done:
- **问题3 - 文件去重**（已在之前完成）：
  - 在 lib/supabase/fileService.ts 中添加 `deduplicateFiles()` 函数
  - 根据 file_name + file_size 去重，保留最新的文件
  - 在 getUserFiles() 中调用去重逻辑

- **问题1 - 修复布局和自动引用**：
  - 修改 components/home/ChatInput.tsx：
    - 添加独立的文件上传功能（uploadFiles、isUploading 状态）
    - 上传成功后自动调用 `onUploadComplete` 回调
    - 上传中显示 "上传中..." 状态
    - 上传失败时显示错误提示
  - 文件列表显示紫色背景样式（bg-primary/10 text-primary）

  - 修改 components/layout/AppLayout.tsx：
    - 添加 `onUploadComplete` prop 传递给 Sidebar

  - 修改 components/layout/Sidebar.tsx：
    - Projects 区域改为 `flex-none`（固定高度，让 File Library 自动填充剩余空间）
    - File Library 区域改为 `flex-1 flex-col min-h-0`（动态填充）
    - 移除上传对话框和相关代码
    - 移除 `handleUpload` 函数
    - 修改为接收 `onUploadComplete` 回调
    - 在文件项引用按钮点击时调用回调

  - 修改 app/page.tsx：
    - 实现完整的文件上传状态管理
    - 添加 `handleUploadComplete` 函数
    - 添加文件去重逻辑（避免重复添加到附件列表）
    - 传递 `onUploadComplete` 给 AppLayout 和 ChatInput

### Testing:
- ✅ npm run build 成功
- ✅ TypeScript 编译通过
- ✅ 文件库布局已优化（Projects 固定高度，File Library 动态填充）
- ✅ 上传功能完全集成到 ChatInput
- ✅ 上传后自动引用文件到输入框
- ✅ 文件库引用按钮点击也能添加到输入框

### Notes:
- ChatInput 现在是独立的文件上传入口，不再依赖 Sidebar
- 上传完成后通过 `onUploadComplete` 回调机制通知其他组件
- 文件上传、引用、删除三者的数据流现在完全统一

---

## 2026-02-19 - Fix: Add independent scrollbars for left and right panels
